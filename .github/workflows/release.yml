name: Build and Release with Installer

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install PyQt6 PyQt6-Qt6 PyQt6-sip --force-reinstall
          pip install pyinstaller
          echo "=== DEPENDENCIES INSTALLED ==="
          pip list

      - name: Build with PyInstaller
        run: |
          python -m PyInstaller build_windows.spec --clean --noconfirm
          echo "=== PYINSTALLER BUILD COMPLETE ==="

      - name: Prepare installer assets
        run: |
          # Create dist directory for installer
          mkdir dist\installer
          
          # Copy PyInstaller output
          Copy-Item dist\BioDockify-Docking-Studio.exe -Destination dist\installer
          
          # Copy templates and styles
          # Note: Source structure is src\templates and src\ui\styles
          # But we want them in dist\installer\templates and dist\installer\ui\styles
          Copy-Item src\templates -Destination dist\installer -Recurse
          
          # UI/Styles needs parent dir structure creation first or direct copy
          mkdir dist\installer\ui
          Copy-Item src\ui\styles -Destination dist\installer\ui -Recurse
          
          # Copy documentation
          Copy-Item LICENSE -Destination dist\installer
          Copy-Item README.md -Destination dist\installer
          Copy-Item README.md -Destination dist\installer
          Copy-Item src\ui\styles\icon.ico -Destination dist\installer\biodockify_icon.ico
          
          # Copy Installer Script
          Copy-Item installer.nsi -Destination dist\installer

      - name: Prepare Installer Assets
        run: |
          pip install Pillow
          # We need to copy the source image from the brain directory to a known location, 
          # BUT in GitHub Actions, the 'brain' dir won't exist. 
          # For this environment, we assume the user committed the image or we need to put it there.
          # WAIT: The uploaded image is LOCAL. The GitHub Action runs on a remote VM.
          # We must COMMIT the image to the repo for the Action to see it.
          # I will fallback to generating a placeholder if missing, OR I will commit the image now.
          
          python scripts/prepare_installer_assets.py "src/assets/installer_logo_source.jpg" "dist/installer"
          
          # Verify assets exist
          if (!(Test-Path "dist\installer\header.bmp")) {
             Write-Error "Header bitmap not generated!"
          }

      - name: Setup NSIS
        run: |
          # Install NSIS via Chocolatey
          choco install nsis -y
          
          # Verify NSIS installation using full path
          & 'C:\Program Files (x86)\NSIS\makensis.exe' /VERSION

      - name: Install NSIS Plugins
        run: |
          # Download Inetc plugin
          Invoke-WebRequest -Uri "https://nsis.sourceforge.io/mediawiki/images/c/c9/Inetc.zip" -OutFile "inetc.zip"
          Expand-Archive -Path "inetc.zip" -DestinationPath "inetc"
          
          # Copy x86-unicode plugin to NSIS plugins directory
          # NSIS 3.x uses x86-unicode by default for unicode installers
          Copy-Item "inetc/Plugins/x86-unicode/inetc.dll" -Destination "C:\Program Files (x86)\NSIS\Plugins\x86-unicode\" -Force
          
          # Also copy legacy ansi/x86 just in case
          Copy-Item "inetc/Plugins/x86-ansi/inetc.dll" -Destination "C:\Program Files (x86)\NSIS\Plugins\x86-ansi\" -Force

      - name: Create NSIS Installer
        run: |
          # Build the installer using full path
          cd dist\installer
          & 'C:\Program Files (x86)\NSIS\makensis.exe' installer.nsi
          
          # Move installer to dist root
          Move-Item BioDockify-Setup-*.exe -Destination ..\..

      - name: Create Docker check script
        run: |
          Copy-Item scripts\check_docker.bat -Destination dist\installer\check_docker.bat

      - name: Generate Checksums
        shell: pwsh
        run: |
          $files = @(
            "dist\BioDockify-Setup-*.exe",
            "dist\BioDockify-Docking-Studio.exe"
          )
          
          foreach ($file in $files) {
            # Handle wildcard expansion
            $matchingFiles = Get-ChildItem $file
            foreach ($match in $matchingFiles) {
                if (Test-Path $match.FullName) {
                  $hash = (Get-FileHash $match.FullName -Algorithm SHA256).Hash.ToLower()
                  $filename = $match.Name
                  "$hash $filename" | Out-File -FilePath dist\checksums.txt -Append -Encoding ascii
                  Write-Host "Checksum: $hash - $filename"
                }
            }
          }

      - name: Display build artifacts
        run: |
          echo "=== BUILD ARTIFACTS ==="
          Get-ChildItem dist -Recurse | Select-Object FullName

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/BioDockify-Setup-*.exe
            dist/BioDockify-Docking-Studio.exe
            dist/checksums.txt
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
